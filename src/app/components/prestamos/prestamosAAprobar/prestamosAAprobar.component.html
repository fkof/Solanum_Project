<div class="container-general">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>
  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header">
        <div class="header-content">
          <h2 class="header-title">Gestión de Prestamos</h2>
          <p class="header-subtitle">Consulta los prestamos por Colaborador</p>
        </div>

      </div>
    </ng-template>



    <div class="prestamos-container">

      <div class="search-form">
        <div class="form-grid">
          <div class="form-field">
            <label class="field-label">Nombre Colaborador</label>

            <input pInputText id="nombre" [(ngModel)]="nombreBusqueda" name="nombre" class="w-full" />


          </div>
          <div class="form-field">
            <label class="field-label">Fecha Inicial</label>
            <p-datepicker inputId="fechaInicial" [disabledDates]="disabledDates" [(ngModel)]="fechaInicial"
              name="fechaInicial" [showIcon]="true" dateFormat="dd-M-yy" class="w-full"
              [iconDisplay]="'input'"></p-datepicker>
          </div>
          <div class="form-field">
            <label class="field-label">Fecha Final</label>
            <p-datepicker inputId="fechaFinal" name="fechaFinal" [showIcon]="true" dateFormat="dd-M-yy"
              [disabledDates]="disabledDates" [(ngModel)]="fechaFinal" class="w-full"
              [iconDisplay]="'input'"></p-datepicker>
          </div>
          <div class="form-field">
            <label class="field-label">Estatus</label>
            <p-select styleClass="{'padding:0.75rem'}" inputId="empresa" [options]="listEstatus"
              [(ngModel)]="estatusSeleccionado" name="empresa" optionLabel="nombre" [filter]="true"
              optionValue="idEstatus" filterBy="name" placeholder="Estatus de solicitudes" [showClear]="true"
              class="w-full"></p-select>
          </div>
          <div class="form-field">
            <label class="field-label">Estatus Prestamo</label>
            <p-select styleClass="{'padding:0.75rem'}" inputId="empresa" [options]="listEstatusPrestamo"
              [(ngModel)]="estatusPrestamoSeleccionado" name="empresa" optionLabel="descripcion" [filter]="true"
              optionValue="id" filterBy="name" placeholder="Estatus de prestamos" [showClear]="true"
              class="w-full"></p-select>
          </div>
          <div class="form-field" style="align-self: end;">
            <p-button label="Buscar" (onClick)="buscarsolicitudes()" icon="pi pi-search" [loading]="loading"
              styleClass="p-button-primary" class="w-full"></p-button>
          </div>
        </div>
      </div>

    </div>
    <!-- Separador -->
    <div class="separator"></div>

    <!-- Tabla de resultados -->
    <div class="results-section" [ngStyle]="{'max-width': 'fit-content'}">
      <h3 class="results-title">
        <i class="pi pi-list"></i>
        Solicitudes

      </h3>


      <p-table #dt [value]="solicitudesPrestamos" [loading]="loading" [paginator]="true" [rows]="10"
        [rowsPerPageOptions]="[5, 10, 20]" [showCurrentPageReport]="true" [tableStyle]="{'max-width': 'fit-content'}"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} solicitudes" [scrollable]="true"
        styleClass="p-datatable-gridlines" [responsive]="true">
        <ng-template #caption>
          <div class="text-end pb-4">
            <p-button icon="pi pi-external-link" styleClass="p-button-primary" label="Export"
              (onClick)="handleExportExcel()" />
          </div>
        </ng-template>
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="idSolicitud" style="width: 70px">
              ID <p-sortIcon field="idSolicitud"></p-sortIcon>
            </th>
            <th pSortableColumn="nombreCompleto" style="width: 200px">
              Nombre Completo <p-sortIcon field="nombreCompleto"></p-sortIcon>
            </th>
            <th pSortableColumn="montoSolicitado">
              Monto Solicitado <p-sortIcon field="montoSolicitado"></p-sortIcon>
            </th>
            <th pSortableColumn="cantidadRebaje">
              Desc. por semana <p-sortIcon field="cantidadRebaje"></p-sortIcon>
            </th>
            <th pSortableColumn="fechaCreacion">
              Fecha Creacion <p-sortIcon field="fechaCreacion"></p-sortIcon>
            </th>
            <th pSortableColumn="estatus">
              Estado Sol <p-sortIcon field="estatus"></p-sortIcon>
            </th>
            <th pSortableColumn="estatusPrestamo">
              Estado Prestamo <p-sortIcon field="estatusPrestamo"></p-sortIcon>
            </th>
            <th pSortableColumn="motivoRechazo">
              Motivo Rechazo <p-sortIcon field="motivoRechazo"></p-sortIcon>
            </th>
            <th pSortableColumn="">
              Cancelacion <p-sortIcon field=""></p-sortIcon>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-solicitud>
          <tr>
            <td>
              <span class="numero-nomina">
                {{ solicitud.idSolicitud }}
              </span>
            </td>
            <td> <span class="nombre-empleado"> {{ solicitud.nombreCompleto }} </span></td>

            <td> <span class="nombre-empleado"> {{ solicitud.montoSolicitado }} </span></td>
            <td> <span class="default-texto"> {{ solicitud.cantidadRebaje }}</span></td>
            <td> <span class="default-texto"> {{globalHelpers.formatearFechastr( solicitud.fechaCreacion )}}</span></td>

            <td> <p-tag [value]="solicitud.estatus" [severity]="globalHelpers.getSeverityStatus(solicitud.estatus)" />
            </td>
            <td> <p-tag [value]="solicitud.estatusPrestamo"
                [severity]="globalHelpers.getSeverityStatus(solicitud.estatusPrestamo)" />
            </td>
            <td> <span class="default-texto"> {{ solicitud.motivoRechazo || '—' }}</span></td>
            <td>
              <div class="action-buttons">
                <p-button icon="pi pi-eye" *ngIf="solicitud.estatus==='Pendiente'  "
                  styleClass="p-button-rounded p-button-text p-button-danger delete-btn" [pTooltip]="'Ver Solicitud'"
                  (onClick)="selectSolicitudApprove(solicitud)" tooltipPosition="top"></p-button>
              </div>
              <div class="action-buttons">
                <p-button icon="pi pi-money-bill" *ngIf="solicitud.estatus==='Autorizada'  "
                  styleClass="p-button-rounded p-button-text p-button-danger delete-btn"
                  [pTooltip]="'Ver Amortizaciones'" (onClick)="selectSolicitudApprove(solicitud)"
                  tooltipPosition="top"></p-button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="empty-message">
              <div class="empty-state">
                <i class="pi pi-search empty-icon"></i>
                <p>No se encontraron Solitudes pendientes.</p>

              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="loadingbody">
          <tr>
            <td colspan="7">
              <div class="loading-state">
                <i class="pi pi-spin pi-spinner loading-icon"></i>
                <p>Buscando Solicitudes...</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>


    <p-dialog header="Resumen de Solicitud" [modal]="true" [(visible)]="showDialog" [style]="{'width': '50vw'}"
      (onHide)="showDialog = false">
      <div class="container_solicitud">
        <h2>Monto solicitado</h2>
        <div class="date-box">{{ selectSolicitud?.montoSolicitado }}</div>

        <h2>Cantidad a rebajar por semana</h2>
        <div class="date-box">{{selectSolicitud?.cantidadRebaje }}</div>

        <h2>Motivo</h2>
        <div class="date-box">{{selectSolicitud?.motivo}}</div>
        <p-panel [header]="headerAmortizacion" [toggleable]="true">

          <p-table #dt [value]="simulacionAmortizacion" [loading]="loading" [paginator]="true" [rows]="5"
            *ngIf="selectSolicitud?.estatus !== 'Autorizada'" [rowsPerPageOptions]="[5]" [showCurrentPageReport]="true"
            scrollHeight="400px" [tableStyle]="{ 'min-width': '30rem','max-height': '20rem' }"
            styleClass="p-datatable-gridlines"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} solicitudes" [scrollable]="true"
            [responsive]="true">

            <ng-template pTemplate="header">
              <tr>
                <th style="width: 80px">
                  No. Pago
                </th>
                <th style="min-width: 200px">
                  Fecha Pago
                </th>
                <th style="min-width: 300px">
                  Monto Pago
                </th>
                <th style="width: 120px">
                  Saldo Pendiente
                </th>
              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-amortizacion>
              <tr>
                <td>
                  <span class="numero-nomina">
                    {{ amortizacion.numeroPago }}
                  </span>
                </td>

                <td> <span class="default-texto"> {{globalHelpers.formatearFechastr( amortizacion.fechaPago )}}</span>
                </td>
                <td> {{ amortizacion.monto }}</td>
                <td> {{ amortizacion.saldoRestante }}</td>

              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="5" class="empty-message">
                  <div class="empty-state">
                    <i class="pi pi-search empty-icon"></i>
                    <p>No se encontraron Solitudes pendientes.</p>

                  </div>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
              <tr>
                <td colspan="5">
                  <div class="loading-state">
                    <i class="pi pi-spin pi-spinner loading-icon"></i>
                    <p>Buscando Solicitudes...</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>

          <p-table #dt [value]="simulacionAmortizacion" [loading]="loading" [paginator]="true" [rows]="5"
            *ngIf="selectSolicitud?.estatus === 'Autorizada'" [rowsPerPageOptions]="[5]" [showCurrentPageReport]="true"
            scrollHeight="400px" [tableStyle]="{ 'min-width': '30rem','max-height': '20rem' }"
            styleClass="p-datatable-gridlines"
            currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} solicitudes" [scrollable]="true"
            [responsive]="true">

            <ng-template pTemplate="header">
              <tr>
                <th style="width: 80px">
                  No. Pago
                </th>
                <th style="min-width: 200px">
                  Fecha Pago
                </th>
                <th style="min-width: 300px">
                  Monto Pago
                </th>
                <th style="width: 120px">
                  Pago Aplicado
                </th>

              </tr>
            </ng-template>

            <ng-template pTemplate="body" let-amortizacion>
              <tr>
                <td>
                  <span class="numero-nomina">
                    {{ amortizacion.numeroPago }}
                  </span>
                </td>

                <td> <span class="default-texto"> {{globalHelpers.formatearFechastr( amortizacion.fechaPago )}}</span>
                </td>
                <td> {{ amortizacion.monto }}</td>
                <td><p-tag icon="pi pi-times" severity="danger" value="No" *ngIf="!amortizacion.pagoAplicado" /> </td>

              </tr>
            </ng-template>

            <ng-template pTemplate="emptymessage">
              <tr>
                <td colspan="6" class="empty-message">
                  <div class="empty-state">
                    <i class="pi pi-search empty-icon"></i>
                    <p>No se encontraron Solitudes pendientes.</p>

                  </div>
                </td>
              </tr>
            </ng-template>

            <ng-template pTemplate="loadingbody">
              <tr>
                <td colspan="6">
                  <div class="loading-state">
                    <i class="pi pi-spin pi-spinner loading-icon"></i>
                    <p>Buscando Solicitudes...</p>
                  </div>
                </td>
              </tr>
            </ng-template>
          </p-table>

        </p-panel>
        <div style="display: flex; justify-content: center; padding-top: 20px;"
          *ngIf="selectSolicitud?.estatus!=='Autorizada'">
          <p-button label="Cerrar" icon="pi pi-window-minimize" (onClick)="showDialog =false"
            styleClass="p-button-outlined" [style]="{'margin-right':'10px'}"></p-button>

          <p-button label="Rechazar Solicitud" icon="pi pi-times" severity="danger" [style]="{'margin-right':'10px'}"
            (onClick)="showMotivos =true"></p-button>

          <p-button label="Aprobar" icon="pi pi-check" (onClick)="preguntaAprobarSolicitud()" [loading]="loading"
            styleClass="p-button-primary" class="w-full mx-12"></p-button>
        </div>



      </div>


    </p-dialog>

    <p-dialog header="Rechazo de Solicitud" [modal]="true" [(visible)]="showMotivos" [style]="{ width: '25rem' }">
      <div class="flex items-center gap-4 mb-4" style="margin-bottom: 20px;">
        <label for="username" class="font-semibold w-24">Motivo de Rechazo</label>
        <input pInputText id="username" class="flex-auto" autocomplete="off" [(ngModel)]="motivoRechazo" />
      </div>
      <div class="flex justify-end gap-2">
        <p-button label="Cancelar" severity="secondary" (click)="showMotivos = false" styleClass="p-button-outlined"
          [style]="{'margin-right':'10px'}" />
        <p-button label="Rechazar Solicitud" icon="pi pi-times" severity="danger" [style]="{'margin-right':'10px'}"
          (onClick)="preguntaCancelar()"></p-button>
      </div>
    </p-dialog>

  </p-card>
</div>